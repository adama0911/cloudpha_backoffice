/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { DOCUMENT } from '@angular/common';
import { HttpClient, HttpBackend } from '@angular/common/http';
import { Optional, Inject, RendererFactory2 } from '@angular/core';
import { of as observableOf } from 'rxjs';
import { catchError, map, share, tap } from 'rxjs/operators';
import { getSecondaryColor, withSuffix, isIconDefinition, printErr, printWarn, cloneSVG, withSuffixAndColor, getIconDefinitionFromAbbr, replaceFillColor } from '../utils';
/**
 * @record
 */
export function ReqIconTask() { }
if (false) {
    /** @type {?} */
    ReqIconTask.prototype.ob;
}
var IconService = /** @class */ (function () {
    function IconService(_rendererFactory, _handler, _document) {
        this._rendererFactory = _rendererFactory;
        this._handler = _handler;
        this._document = _document;
        this.defaultTheme = 'outline';
        /**
         * Register icons.
         */
        this._svgDefinitions = new Map();
        /**
         * Register rendered (with color) SVG icons.
         */
        this._svgCachedDefinitions = new Map();
        /**
         * Default color settings.
         */
        this._twoToneColorPalette = {
            primaryColor: '#333333',
            secondaryColor: '#E6E6E6'
        };
        this._assetsSource = '';
        /**
         * To note whether a request to an icon is under processing.
         */
        this._httpQueue = new Map();
        // For SSR.
        this._renderer = this._rendererFactory.createRenderer(null, null);
        if (this._handler) {
            this._http = new HttpClient(this._handler);
        }
    }
    Object.defineProperty(IconService.prototype, "twoToneColor", {
        get: /**
         * @return {?}
         */
        function () {
            return (/** @type {?} */ (tslib_1.__assign({}, this.twoToneColor))); // Make a copy to avoid unexpected changes.
        },
        set: /**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var primaryColor = _a.primaryColor, secondaryColor = _a.secondaryColor;
            if (primaryColor && typeof primaryColor === 'string' && typeof secondaryColor === 'string' || typeof secondaryColor === 'undefined') {
                this._twoToneColorPalette.primaryColor = primaryColor;
                this._twoToneColorPalette.secondaryColor = secondaryColor || getSecondaryColor(primaryColor);
            }
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Register IconDefinition provided by Ant Design, parsing AbstractNode to svg string.
     * @param icons
     */
    /**
     * Register IconDefinition provided by Ant Design, parsing AbstractNode to svg string.
     * @param {...?} icons
     * @return {?}
     */
    IconService.prototype.addIcon = /**
     * Register IconDefinition provided by Ant Design, parsing AbstractNode to svg string.
     * @param {...?} icons
     * @return {?}
     */
    function () {
        var icons = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            icons[_i] = arguments[_i];
        }
        this._addIconLiteral.apply(this, tslib_1.__spread(icons));
    };
    /**
     * @param {?} prefix
     * @return {?}
     */
    IconService.prototype.changeAssetsSource = /**
     * @param {?} prefix
     * @return {?}
     */
    function (prefix) {
        this._assetsSource = prefix.endsWith('/') ? prefix : prefix + '/';
    };
    /**
     * Register icon.
     * @param icons Icons that users want to use in their projects. User defined icons and predefined
     *   icons provided by ant-design should implement IconDefinition both.
     */
    /**
     * Register icon.
     * @param {...?} icons Icons that users want to use in their projects. User defined icons and predefined
     *   icons provided by ant-design should implement IconDefinition both.
     * @return {?}
     */
    IconService.prototype._addIconLiteral = /**
     * Register icon.
     * @param {...?} icons Icons that users want to use in their projects. User defined icons and predefined
     *   icons provided by ant-design should implement IconDefinition both.
     * @return {?}
     */
    function () {
        var _this = this;
        var icons = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            icons[_i] = arguments[_i];
        }
        icons.forEach(function (icon) {
            _this._svgDefinitions.set(withSuffix(icon.name, icon.theme), icon);
        });
    };
    /**
     * @param {?} key
     * @return {?}
     */
    IconService.prototype._get = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        return this._svgDefinitions.get(key) || null;
    };
    /**
     * Get an static file and return it as a string, create a IconDefinition and cache it or return null.
     */
    /**
     * Get an static file and return it as a string, create a IconDefinition and cache it or return null.
     * @param {?} url
     * @return {?}
     */
    IconService.prototype._getFromRemote = /**
     * Get an static file and return it as a string, create a IconDefinition and cache it or return null.
     * @param {?} url
     * @return {?}
     */
    function (url) {
        if (this._http) {
            /** @type {?} */
            var task = this._httpQueue.get(url);
            /** @type {?} */
            var ob = void 0;
            if (task) {
                ob = task.ob;
            }
            else {
                ob = this._createObservableRequest(url);
                task = { ob: ob };
                this._httpQueue.set(url, task);
            }
            return ob;
        }
        else {
            printWarn('You need to import HttpClient module to use dynamic importing');
            return observableOf(null);
        }
    };
    /**
     * @param {?} url
     * @return {?}
     */
    IconService.prototype._createObservableRequest = /**
     * @param {?} url
     * @return {?}
     */
    function (url) {
        var _this = this;
        /** @type {?} */
        var icon = getIconDefinitionFromAbbr(url);
        return this._http.get(this._assetsSource + "assets/" + icon.theme + "/" + icon.name + ".svg", { responseType: 'text' }).pipe(share(), // Use `share` so if multi directives request the same icon, HTTP request would only be fired once.
        tap(function () {
            _this._httpQueue.delete(url);
        }), map(function (svgString) {
            icon.icon = svgString;
            _this._addIconLiteral(icon);
            return icon;
        }), catchError(function () {
            printErr("the icon " + url + " does not exist in your assets folder");
            _this._httpQueue.delete(url);
            return observableOf(null);
        }));
    };
    /**
     * Icon component would call this method to get a SVG element.
     * This method returns a Observable SVG element because when user wants to get an icon from URL, it would be async,
     * so we provided a unified interface here.
     *
     * TODO: namespace in the future
     */
    /**
     * Icon component would call this method to get a SVG element.
     * This method returns a Observable SVG element because when user wants to get an icon from URL, it would be async,
     * so we provided a unified interface here.
     *
     * TODO: namespace in the future
     * @param {?} icon
     * @param {?=} twoToneColor
     * @return {?}
     */
    IconService.prototype.getRenderedContent = /**
     * Icon component would call this method to get a SVG element.
     * This method returns a Observable SVG element because when user wants to get an icon from URL, it would be async,
     * so we provided a unified interface here.
     *
     * TODO: namespace in the future
     * @param {?} icon
     * @param {?=} twoToneColor
     * @return {?}
     */
    function (icon, twoToneColor) {
        var _this = this;
        /** @type {?} */
        var definitionOrNull = isIconDefinition(icon)
            ? (/** @type {?} */ (icon))
            : this._get((/** @type {?} */ (icon)));
        /** @type {?} */
        var $icon = definitionOrNull ? observableOf(definitionOrNull) : this._getFromRemote((/** @type {?} */ (icon)));
        return $icon.pipe(map(function (i) {
            if (i) {
                return _this._loadSVGFromCacheOrCreateNew(i, twoToneColor);
            }
            else {
                printErr("the icon " + icon + " does not exist or is not registered");
                return null;
            }
        }));
    };
    /**
     * @param {?} icon
     * @param {?=} twoToneColor
     * @return {?}
     */
    IconService.prototype._loadSVGFromCacheOrCreateNew = /**
     * @param {?} icon
     * @param {?=} twoToneColor
     * @return {?}
     */
    function (icon, twoToneColor) {
        /** @type {?} */
        var svg;
        /** @type {?} */
        var pri = twoToneColor || this._twoToneColorPalette.primaryColor;
        /** @type {?} */
        var sec = getSecondaryColor(pri) || this._twoToneColorPalette.secondaryColor;
        /** @type {?} */
        var key = withSuffixAndColor(icon.name, icon.theme, pri, sec);
        /** @type {?} */
        var cached = this._svgCachedDefinitions.get(key);
        // If this icon is used before, there should be a copy in cachedDefinitions, just copy it.
        // Otherwise, generate one from string or SVG element, and cache it.
        if (!cached) {
            svg = this._setSVGAttribute(this._colorizeSVGIcon(typeof icon.icon === 'string'
                ? this._createSVGElementFromString(icon.icon)
                : icon.icon, (icon.theme === 'twotone'), pri, sec));
            this._svgCachedDefinitions.set(key, (/** @type {?} */ (tslib_1.__assign({}, icon, { icon: svg }))));
        }
        else {
            svg = cached.icon;
        }
        return cloneSVG(svg);
    };
    /**
     * @param {?} str
     * @return {?}
     */
    IconService.prototype._createSVGElementFromString = /**
     * @param {?} str
     * @return {?}
     */
    function (str) {
        /** @type {?} */
        var colorParsed = replaceFillColor(str);
        /** @type {?} */
        var div = this._document.createElement('div');
        div.innerHTML = colorParsed;
        /** @type {?} */
        var svg = div.querySelector('svg');
        if (!svg) {
            throw Error('<svg> tag not found');
        }
        return svg;
    };
    /**
     * @param {?} svg
     * @return {?}
     */
    IconService.prototype._setSVGAttribute = /**
     * @param {?} svg
     * @return {?}
     */
    function (svg) {
        this._renderer.setAttribute(svg, 'width', '1em');
        this._renderer.setAttribute(svg, 'height', '1em');
        return svg;
    };
    /**
     * @param {?} svg
     * @param {?} twotone
     * @param {?} pri
     * @param {?} sec
     * @return {?}
     */
    IconService.prototype._colorizeSVGIcon = /**
     * @param {?} svg
     * @param {?} twotone
     * @param {?} pri
     * @param {?} sec
     * @return {?}
     */
    function (svg, twotone, pri, sec) {
        if (twotone) {
            /** @type {?} */
            var children = svg.childNodes;
            /** @type {?} */
            var length_1 = children.length;
            for (var i = 0; i < length_1; i++) {
                /** @type {?} */
                var child = (/** @type {?} */ (children[i]));
                if (child.getAttribute('fill') === 'secondaryColor') {
                    this._renderer.setAttribute(child, 'fill', sec);
                }
                else {
                    this._renderer.setAttribute(child, 'fill', pri);
                }
            }
        }
        this._renderer.setAttribute(svg, 'fill', 'currentColor');
        return svg;
    };
    /**
     * Clear all cached icons.
     */
    /**
     * Clear all cached icons.
     * @return {?}
     */
    IconService.prototype.clear = /**
     * Clear all cached icons.
     * @return {?}
     */
    function () {
        this._svgDefinitions.clear();
    };
    IconService.ctorParameters = function () { return [
        { type: RendererFactory2 },
        { type: HttpBackend, decorators: [{ type: Optional }] },
        { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [DOCUMENT,] }] }
    ]; };
    return IconService;
}());
export { IconService };
if (false) {
    /** @type {?} */
    IconService.prototype.defaultTheme;
    /** @type {?} */
    IconService.prototype._renderer;
    /** @type {?} */
    IconService.prototype._http;
    /**
     * Register icons.
     * @type {?}
     */
    IconService.prototype._svgDefinitions;
    /**
     * Register rendered (with color) SVG icons.
     * @type {?}
     */
    IconService.prototype._svgCachedDefinitions;
    /**
     * Default color settings.
     * @type {?}
     */
    IconService.prototype._twoToneColorPalette;
    /** @type {?} */
    IconService.prototype._assetsSource;
    /**
     * To note whether a request to an icon is under processing.
     * @type {?}
     */
    IconService.prototype._httpQueue;
    /** @type {?} */
    IconService.prototype._rendererFactory;
    /** @type {?} */
    IconService.prototype._handler;
    /** @type {?} */
    IconService.prototype._document;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWNvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGFudC1kZXNpZ24vaWNvbnMtYW5ndWxhci8iLCJzb3VyY2VzIjpbImNvbXBvbmVudC9pY29uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBYSxnQkFBZ0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5RSxPQUFPLEVBQWMsRUFBRSxJQUFJLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFRN0QsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixVQUFVLEVBQ1YsZ0JBQWdCLEVBQ2hCLFFBQVEsRUFDUixTQUFTLEVBQ1QsUUFBUSxFQUNSLGtCQUFrQixFQUNsQix5QkFBeUIsRUFDekIsZ0JBQWdCLEVBQ2pCLE1BQU0sVUFBVSxDQUFDOzs7O0FBRWxCLGlDQUVDOzs7SUFEQyx5QkFBc0M7O0FBR3hDO0lBME1FLHFCQUNZLGdCQUFrQyxFQUN0QixRQUFxQixFQUNILFNBQWM7UUFGNUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUN0QixhQUFRLEdBQVIsUUFBUSxDQUFhO1FBQ0gsY0FBUyxHQUFULFNBQVMsQ0FBSztRQTVNeEQsaUJBQVksR0FBYyxTQUFTLENBQUM7UUFLcEM7O1dBRUc7UUFDTyxvQkFBZSxHQUFHLElBQUksR0FBRyxFQUEwQixDQUFDO1FBRTlEOztXQUVHO1FBQ08sMEJBQXFCLEdBQUcsSUFBSSxHQUFHLEVBQWdDLENBQUM7UUFFMUU7O1dBRUc7UUFDTyx5QkFBb0IsR0FBd0I7WUFDcEQsWUFBWSxF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QUMsQ0FBQztnQkFDbEQsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO1FBQ0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxjQUFjLENBQUMsQ0FBQztRQUN6RCxNQUFNLENBQUMsR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVEOztPQUVHOzs7OztJQUNILDJCQUFLOzs7O0lBQUw7UUFDRSxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQy9CLENBQUM7O2dCQWxPbUMsZ0JBQWdCO2dCQURqQyxXQUFXLHVCQXVPM0IsUUFBUTtnREFDUixRQUFRLFlBQUksTUFBTSxTQUFDLFFBQVE7O0lBUWhDLGtCQUFDO0NBQUEsQUFyTkQsSUFxTkM7U0FyTlksV0FBVzs7O0lBQ3RCLG1DQUFvQzs7SUFFcEMsZ0NBQStCOztJQUMvQiw0QkFBNEI7Ozs7O0lBSzVCLHNDQUE4RDs7Ozs7SUFLOUQsNENBQTBFOzs7OztJQUsxRSwyQ0FHRTs7SUFFRixvQ0FBNkI7Ozs7O0lBSzdCLGlDQUFzRDs7SUE4S3BELHVDQUE0Qzs7SUFDNUMsK0JBQTJDOztJQUMzQyxnQ0FBc0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwQmFja2VuZCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IE9wdGlvbmFsLCBJbmplY3QsIFJlbmRlcmVyMiwgUmVuZGVyZXJGYWN0b3J5MiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgYXMgb2JzZXJ2YWJsZU9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBtYXAsIHNoYXJlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1xuICBJY29uRGVmaW5pdGlvbixcbiAgQ2FjaGVkSWNvbkRlZmluaXRpb24sXG4gIFR3b1RvbmVDb2xvclBhbGV0dGUsXG4gIFR3b1RvbmVDb2xvclBhbGV0dGVTZXR0ZXIsXG4gIFRoZW1lVHlwZVxufSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQge1xuICBnZXRTZWNvbmRhcnlDb2xvcixcbiAgd2l0aFN1ZmZpeCxcbiAgaXNJY29uRGVmaW5pdGlvbixcbiAgcHJpbnRFcnIsXG4gIHByaW50V2FybixcbiAgY2xvbmVTVkcsXG4gIHdpdGhTdWZmaXhBbmRDb2xvcixcbiAgZ2V0SWNvbkRlZmluaXRpb25Gcm9tQWJicixcbiAgcmVwbGFjZUZpbGxDb2xvclxufSBmcm9tICcuLi91dGlscyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxSWNvblRhc2sge1xuICBvYjogT2JzZXJ2YWJsZTxJY29uRGVmaW5pdGlvbiB8IG51bGw+O1xufVxuXG5leHBvcnQgY2xhc3MgSWNvblNlcnZpY2Uge1xuICBkZWZhdWx0VGhlbWU6IFRoZW1lVHlwZSA9ICdvdXRsaW5lJztcblxuICBwcm90ZWN0ZWQgX3JlbmRlcmVyOiBSZW5kZXJlcjI7XG4gIHByb3RlY3RlZCBfaHR0cDogSHR0cENsaWVudDtcblxuICAvKipcbiAgICogUmVnaXN0ZXIgaWNvbnMuXG4gICAqL1xuICBwcm90ZWN0ZWQgX3N2Z0RlZmluaXRpb25zID0gbmV3IE1hcDxzdHJpbmcsIEljb25EZWZpbml0aW9uPigpO1xuXG4gIC8qKlxuICAgKiBSZWdpc3RlciByZW5kZXJlZCAod2l0aCBjb2xvcikgU1ZHIGljb25zLlxuICAgKi9cbiAgcHJvdGVjdGVkIF9zdmdDYWNoZWREZWZpbml0aW9ucyA9IG5ldyBNYXA8c3RyaW5nLCBDYWNoZWRJY29uRGVmaW5pdGlvbj4oKTtcblxuICAvKipcbiAgICogRGVmYXVsdCBjb2xvciBzZXR0aW5ncy5cbiAgICovXG4gIHByb3RlY3RlZCBfdHdvVG9uZUNvbG9yUGFsZXR0ZTogVHdvVG9uZUNvbG9yUGFsZXR0ZSA9IHtcbiAgICBwcmltYXJ5Q29sb3IgIDogJyMzMzMzMzMnLFxuICAgIHNlY29uZGFyeUNvbG9yOiAnI0U2RTZFNidcbiAgfTtcblxuICBwcm90ZWN0ZWQgX2Fzc2V0c1NvdXJjZSA9ICcnO1xuXG4gIC8qKlxuICAgKiBUbyBub3RlIHdoZXRoZXIgYSByZXF1ZXN0IHRvIGFuIGljb24gaXMgdW5kZXIgcHJvY2Vzc2luZy5cbiAgICovXG4gIHByb3RlY3RlZCBfaHR0cFF1ZXVlID0gbmV3IE1hcDxzdHJpbmcsIFJlcUljb25UYXNrPigpO1xuXG4gIHNldCB0d29Ub25lQ29sb3IoeyBwcmltYXJ5Q29sb3IsIHNlY29uZGFyeUNvbG9yIH06IFR3b1RvbmVDb2xvclBhbGV0dGVTZXR0ZXIpIHtcbiAgICBpZiAocHJpbWFyeUNvbG9yICYmIHR5cGVvZiBwcmltYXJ5Q29sb3IgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBzZWNvbmRhcnlDb2xvciA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIHNlY29uZGFyeUNvbG9yID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5fdHdvVG9uZUNvbG9yUGFsZXR0ZS5wcmltYXJ5Q29sb3IgPSBwcmltYXJ5Q29sb3I7XG4gICAgICB0aGlzLl90d29Ub25lQ29sb3JQYWxldHRlLnNlY29uZGFyeUNvbG9yID0gc2Vjb25kYXJ5Q29sb3IgfHwgZ2V0U2Vjb25kYXJ5Q29sb3IocHJpbWFyeUNvbG9yKTtcbiAgICB9XG4gIH1cblxuICBnZXQgdHdvVG9uZUNvbG9yKCk6IFR3b1RvbmVDb2xvclBhbGV0dGVTZXR0ZXIge1xuICAgIHJldHVybiB7IC4uLnRoaXMudHdvVG9uZUNvbG9yIH0gYXMgVHdvVG9uZUNvbG9yUGFsZXR0ZTsgLy8gTWFrZSBhIGNvcHkgdG8gYXZvaWQgdW5leHBlY3RlZCBjaGFuZ2VzLlxuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIEljb25EZWZpbml0aW9uIHByb3ZpZGVkIGJ5IEFudCBEZXNpZ24sIHBhcnNpbmcgQWJzdHJhY3ROb2RlIHRvIHN2ZyBzdHJpbmcuXG4gICAqIEBwYXJhbSBpY29uc1xuICAgKi9cbiAgYWRkSWNvbiguLi5pY29uczogSWNvbkRlZmluaXRpb25bXSk6IHZvaWQge1xuICAgIHRoaXMuX2FkZEljb25MaXRlcmFsKC4uLmljb25zKTtcbiAgfVxuXG4gIGNoYW5nZUFzc2V0c1NvdXJjZShwcmVmaXg6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuX2Fzc2V0c1NvdXJjZSA9IHByZWZpeC5lbmRzV2l0aCgnLycpID8gcHJlZml4IDogcHJlZml4ICsgJy8nO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIGljb24uXG4gICAqIEBwYXJhbSBpY29ucyBJY29ucyB0aGF0IHVzZXJzIHdhbnQgdG8gdXNlIGluIHRoZWlyIHByb2plY3RzLiBVc2VyIGRlZmluZWQgaWNvbnMgYW5kIHByZWRlZmluZWRcbiAgICogICBpY29ucyBwcm92aWRlZCBieSBhbnQtZGVzaWduIHNob3VsZCBpbXBsZW1lbnQgSWNvbkRlZmluaXRpb24gYm90aC5cbiAgICovXG4gIHByb3RlY3RlZCBfYWRkSWNvbkxpdGVyYWwoLi4uaWNvbnM6IEljb25EZWZpbml0aW9uW10pOiB2b2lkIHtcbiAgICBpY29ucy5mb3JFYWNoKGljb24gPT4ge1xuICAgICAgdGhpcy5fc3ZnRGVmaW5pdGlvbnMuc2V0KHdpdGhTdWZmaXgoaWNvbi5uYW1lLCBpY29uLnRoZW1lKSwgaWNvbik7XG4gICAgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX2dldChrZXk6IHN0cmluZyk6IEljb25EZWZpbml0aW9uIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuX3N2Z0RlZmluaXRpb25zLmdldChrZXkpIHx8IG51bGw7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFuIHN0YXRpYyBmaWxlIGFuZCByZXR1cm4gaXQgYXMgYSBzdHJpbmcsIGNyZWF0ZSBhIEljb25EZWZpbml0aW9uIGFuZCBjYWNoZSBpdCBvciByZXR1cm4gbnVsbC5cbiAgICovXG4gIHByb3RlY3RlZCBfZ2V0RnJvbVJlbW90ZSh1cmw6IHN0cmluZyk6IE9ic2VydmFibGU8SWNvbkRlZmluaXRpb24gfCBudWxsPiB7XG4gICAgaWYgKHRoaXMuX2h0dHApIHtcbiAgICAgIGxldCB0YXNrID0gdGhpcy5faHR0cFF1ZXVlLmdldCh1cmwpO1xuICAgICAgbGV0IG9iOiBPYnNlcnZhYmxlPEljb25EZWZpbml0aW9uIHwgbnVsbD47XG4gICAgICBpZiAodGFzaykge1xuICAgICAgICBvYiA9IHRhc2sub2I7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvYiA9IHRoaXMuX2NyZWF0ZU9ic2VydmFibGVSZXF1ZXN0KHVybCk7XG4gICAgICAgIHRhc2sgPSB7IG9iIH07XG4gICAgICAgIHRoaXMuX2h0dHBRdWV1ZS5zZXQodXJsLCB0YXNrKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBvYjtcbiAgICB9IGVsc2Uge1xuICAgICAgcHJpbnRXYXJuKCdZb3UgbmVlZCB0byBpbXBvcnQgSHR0cENsaWVudCBtb2R1bGUgdG8gdXNlIGR5bmFtaWMgaW1wb3J0aW5nJyk7XG4gICAgICByZXR1cm4gb2JzZXJ2YWJsZU9mKG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX2NyZWF0ZU9ic2VydmFibGVSZXF1ZXN0KHVybDogc3RyaW5nKTogT2JzZXJ2YWJsZTxJY29uRGVmaW5pdGlvbiB8IG51bGw+IHtcbiAgICBjb25zdCBpY29uOiBJY29uRGVmaW5pdGlvbiA9IGdldEljb25EZWZpbml0aW9uRnJvbUFiYnIodXJsKTtcbiAgICByZXR1cm4gdGhpcy5faHR0cC5nZXQoXG4gICAgICBgJHt0aGlzLl9hc3NldHNTb3VyY2V9YXNzZXRzLyR7aWNvbi50aGVtZX0vJHtpY29uLm5hbWV9LnN2Z2AsXG4gICAgICB7IHJlc3BvbnNlVHlwZTogJ3RleHQnIH1cbiAgICApLnBpcGUoXG4gICAgICBzaGFyZSgpLCAvLyBVc2UgYHNoYXJlYCBzbyBpZiBtdWx0aSBkaXJlY3RpdmVzIHJlcXVlc3QgdGhlIHNhbWUgaWNvbiwgSFRUUCByZXF1ZXN0IHdvdWxkIG9ubHkgYmUgZmlyZWQgb25jZS5cbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMuX2h0dHBRdWV1ZS5kZWxldGUodXJsKTtcbiAgICAgIH0pLFxuICAgICAgbWFwKHN2Z1N0cmluZyA9PiB7XG4gICAgICAgIGljb24uaWNvbiA9IHN2Z1N0cmluZztcbiAgICAgICAgdGhpcy5fYWRkSWNvbkxpdGVyYWwoaWNvbik7XG4gICAgICAgIHJldHVybiBpY29uO1xuICAgICAgfSksXG4gICAgICBjYXRjaEVycm9yKCgpID0+IHtcbiAgICAgICAgcHJpbnRFcnIoYHRoZSBpY29uICR7dXJsfSBkb2VzIG5vdCBleGlzdCBpbiB5b3VyIGFzc2V0cyBmb2xkZXJgKTtcbiAgICAgICAgdGhpcy5faHR0cFF1ZXVlLmRlbGV0ZSh1cmwpO1xuICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZU9mKG51bGwpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEljb24gY29tcG9uZW50IHdvdWxkIGNhbGwgdGhpcyBtZXRob2QgdG8gZ2V0IGEgU1ZHIGVsZW1lbnQuXG4gICAqIFRoaXMgbWV0aG9kIHJldHVybnMgYSBPYnNlcnZhYmxlIFNWRyBlbGVtZW50IGJlY2F1c2Ugd2hlbiB1c2VyIHdhbnRzIHRvIGdldCBhbiBpY29uIGZyb20gVVJMLCBpdCB3b3VsZCBiZSBhc3luYyxcbiAgICogc28gd2UgcHJvdmlkZWQgYSB1bmlmaWVkIGludGVyZmFjZSBoZXJlLlxuICAgKlxuICAgKiBUT0RPOiBuYW1lc3BhY2UgaW4gdGhlIGZ1dHVyZVxuICAgKi9cbiAgZ2V0UmVuZGVyZWRDb250ZW50KGljb246IEljb25EZWZpbml0aW9uIHwgc3RyaW5nLCB0d29Ub25lQ29sb3I/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPFNWR0VsZW1lbnQgfCBudWxsPiB7XG4gICAgY29uc3QgZGVmaW5pdGlvbk9yTnVsbDogSWNvbkRlZmluaXRpb24gfCBudWxsID0gaXNJY29uRGVmaW5pdGlvbihpY29uKVxuICAgICAgPyBpY29uIGFzIEljb25EZWZpbml0aW9uXG4gICAgICA6IHRoaXMuX2dldChpY29uIGFzIHN0cmluZyk7XG4gICAgY29uc3QgJGljb24gPSBkZWZpbml0aW9uT3JOdWxsID8gb2JzZXJ2YWJsZU9mKGRlZmluaXRpb25Pck51bGwpIDogdGhpcy5fZ2V0RnJvbVJlbW90ZShpY29uIGFzIHN0cmluZyk7XG5cbiAgICByZXR1cm4gJGljb24ucGlwZShcbiAgICAgIG1hcChpID0+IHtcbiAgICAgICAgaWYgKGkpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5fbG9hZFNWR0Zyb21DYWNoZU9yQ3JlYXRlTmV3KGksIHR3b1RvbmVDb2xvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcHJpbnRFcnIoYHRoZSBpY29uICR7aWNvbn0gZG9lcyBub3QgZXhpc3Qgb3IgaXMgbm90IHJlZ2lzdGVyZWRgKTtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfSkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9sb2FkU1ZHRnJvbUNhY2hlT3JDcmVhdGVOZXcoaWNvbjogSWNvbkRlZmluaXRpb24sIHR3b1RvbmVDb2xvcj86IHN0cmluZyk6IFNWR0VsZW1lbnQge1xuICAgIGxldCBzdmc6IFNWR0VsZW1lbnQ7XG4gICAgY29uc3QgcHJpID0gdHdvVG9uZUNvbG9yIHx8IHRoaXMuX3R3b1RvbmVDb2xvclBhbGV0dGUucHJpbWFyeUNvbG9yO1xuICAgIGNvbnN0IHNlYyA9IGdldFNlY29uZGFyeUNvbG9yKHByaSkgfHwgdGhpcy5fdHdvVG9uZUNvbG9yUGFsZXR0ZS5zZWNvbmRhcnlDb2xvcjtcbiAgICBjb25zdCBrZXkgPSB3aXRoU3VmZml4QW5kQ29sb3IoaWNvbi5uYW1lLCBpY29uLnRoZW1lLCBwcmksIHNlYyk7XG4gICAgY29uc3QgY2FjaGVkID0gdGhpcy5fc3ZnQ2FjaGVkRGVmaW5pdGlvbnMuZ2V0KGtleSk7XG5cbiAgICAvLyBJZiB0aGlzIGljb24gaXMgdXNlZCBiZWZvcmUsIHRoZXJlIHNob3VsZCBiZSBhIGNvcHkgaW4gY2FjaGVkRGVmaW5pdGlvbnMsIGp1c3QgY29weSBpdC5cbiAgICAvLyBPdGhlcndpc2UsIGdlbmVyYXRlIG9uZSBmcm9tIHN0cmluZyBvciBTVkcgZWxlbWVudCwgYW5kIGNhY2hlIGl0LlxuICAgIGlmICghY2FjaGVkKSB7XG4gICAgICBzdmcgPSB0aGlzLl9zZXRTVkdBdHRyaWJ1dGUodGhpcy5fY29sb3JpemVTVkdJY29uKFxuICAgICAgICB0eXBlb2YgaWNvbi5pY29uID09PSAnc3RyaW5nJ1xuICAgICAgICAgID8gdGhpcy5fY3JlYXRlU1ZHRWxlbWVudEZyb21TdHJpbmcoaWNvbi5pY29uKVxuICAgICAgICAgIDogaWNvbi5pY29uXG4gICAgICAgICwgKGljb24udGhlbWUgPT09ICd0d290b25lJyksIHByaSwgc2VjXG4gICAgICApKTtcbiAgICAgIHRoaXMuX3N2Z0NhY2hlZERlZmluaXRpb25zLnNldChrZXksIHsgLi4uaWNvbiwgaWNvbjogc3ZnIH0gYXMgQ2FjaGVkSWNvbkRlZmluaXRpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdmcgPSBjYWNoZWQuaWNvbjtcbiAgICB9XG5cbiAgICByZXR1cm4gY2xvbmVTVkcoc3ZnKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfY3JlYXRlU1ZHRWxlbWVudEZyb21TdHJpbmcoc3RyOiBzdHJpbmcpOiBTVkdFbGVtZW50IHtcbiAgICBjb25zdCBjb2xvclBhcnNlZCA9IHJlcGxhY2VGaWxsQ29sb3Ioc3RyKTtcbiAgICBjb25zdCBkaXYgPSB0aGlzLl9kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBkaXYuaW5uZXJIVE1MID0gY29sb3JQYXJzZWQ7XG4gICAgY29uc3Qgc3ZnOiBTVkdFbGVtZW50ID0gZGl2LnF1ZXJ5U2VsZWN0b3IoJ3N2ZycpO1xuICAgIGlmICghc3ZnKSB7XG4gICAgICB0aHJvdyBFcnJvcignPHN2Zz4gdGFnIG5vdCBmb3VuZCcpO1xuICAgIH1cbiAgICByZXR1cm4gc3ZnO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9zZXRTVkdBdHRyaWJ1dGUoc3ZnOiBTVkdFbGVtZW50KTogU1ZHRWxlbWVudCB7XG4gICAgdGhpcy5fcmVuZGVyZXIuc2V0QXR0cmlidXRlKHN2ZywgJ3dpZHRoJywgJzFlbScpO1xuICAgIHRoaXMuX3JlbmRlcmVyLnNldEF0dHJpYnV0ZShzdmcsICdoZWlnaHQnLCAnMWVtJyk7XG4gICAgcmV0dXJuIHN2ZztcbiAgfVxuXG4gIHByb3RlY3RlZCBfY29sb3JpemVTVkdJY29uKHN2ZzogU1ZHRWxlbWVudCwgdHdvdG9uZTogYm9vbGVhbiwgcHJpOiBzdHJpbmcsIHNlYzogc3RyaW5nKTogU1ZHRWxlbWVudCB7XG4gICAgaWYgKHR3b3RvbmUpIHtcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gc3ZnLmNoaWxkTm9kZXM7XG4gICAgICBjb25zdCBsZW5ndGggPSBjaGlsZHJlbi5sZW5ndGg7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGNoaWxkOiBIVE1MRWxlbWVudCA9IGNoaWxkcmVuWyBpIF0gYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgIGlmIChjaGlsZC5nZXRBdHRyaWJ1dGUoJ2ZpbGwnKSA9PT0gJ3NlY29uZGFyeUNvbG9yJykge1xuICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldEF0dHJpYnV0ZShjaGlsZCwgJ2ZpbGwnLCBzZWMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuX3JlbmRlcmVyLnNldEF0dHJpYnV0ZShjaGlsZCwgJ2ZpbGwnLCBwcmkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuX3JlbmRlcmVyLnNldEF0dHJpYnV0ZShzdmcsICdmaWxsJywgJ2N1cnJlbnRDb2xvcicpO1xuICAgIHJldHVybiBzdmc7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgYWxsIGNhY2hlZCBpY29ucy5cbiAgICovXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIHRoaXMuX3N2Z0RlZmluaXRpb25zLmNsZWFyKCk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgX3JlbmRlcmVyRmFjdG9yeTogUmVuZGVyZXJGYWN0b3J5MixcbiAgICBAT3B0aW9uYWwoKSBwcm90ZWN0ZWQgX2hhbmRsZXI6IEh0dHBCYWNrZW5kLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoRE9DVU1FTlQpIHByb3RlY3RlZCBfZG9jdW1lbnQ6IGFueVxuICApIHtcbiAgICAvLyBGb3IgU1NSLlxuICAgIHRoaXMuX3JlbmRlcmVyID0gdGhpcy5fcmVuZGVyZXJGYWN0b3J5LmNyZWF0ZVJlbmRlcmVyKG51bGwsIG51bGwpO1xuICAgIGlmICh0aGlzLl9oYW5kbGVyKSB7XG4gICAgICB0aGlzLl9odHRwID0gbmV3IEh0dHBDbGllbnQodGhpcy5faGFuZGxlcik7XG4gICAgfVxuICB9XG59XG4iXX0=